<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>数値ランゲーム 最終進化</title>
<style>
  body {
    margin: 0;
    background: #111;
    color: white;
    text-align: center;
    font-family: sans-serif;
  }
  canvas {
    display: block;
    margin: auto;
    background: #222;
  }
</style>
</head>
<body>
<h2>数値ランゲーム</h2>
<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let hp = 100;
const HP_MAX = 100;
let gameOver = false;
let frame = 0;
let startTime = Date.now();
let speedBase = 4; // 初期から速め

// ===== レーン =====
const lanes = [80, 180, 280];
let laneIndex = 1;

// ===== プレイヤー =====
const player = {
  x: lanes[laneIndex],
  y: 500,
  w: 40,
  h: 40,
  scale: 1
};

// ===== サウンド =====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(freq, duration = 0.12) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  gain.gain.value = 0.1;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.stop(audioCtx.currentTime + duration);
}

// BGM
(function bgm(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = 140;
  gain.gain.value = 0.04;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
})();

// ===== 入力 =====
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft" || e.key === "a") {
    laneIndex = Math.max(0, laneIndex - 1);
  }
  if (e.key === "ArrowRight" || e.key === "d") {
    laneIndex = Math.min(2, laneIndex + 1);
  }
});

// ===== アイテム =====
const items = [];

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function spawnItem() {
  const isParam = Math.random() < 0.6;
  const lane = lanes[rand(0, 2)];

  if (isParam) {
    const ops = ["+", "-", "×", "÷"];
    items.push({
      type: "param",
      op: ops[rand(0, 3)],
      value: rand(5, 30),
      x: lane,
      y: -40
    });
  } else {
    items.push({
      type: "enemy",
      value: rand(10, 40),
      x: lane,
      y: -40
    });
  }
}

function isHit(a, b) {
  return (
    a.x < b.x + 40 &&
    a.x + a.w > b.x &&
    a.y < b.y + 30 &&
    a.y + a.h > b.y
  );
}

// ===== 更新 =====
function update() {
  if (gameOver) return;

  frame++;
  player.x = lanes[laneIndex];

  // 経過時間 & スピード加速
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  speedBase = 4 + Math.floor(elapsedSec / 10) * 1.2;

  if (frame % 55 === 0) spawnItem();

  items.forEach(item => item.y += speedBase);

  for (let i = items.length - 1; i >= 0; i--) {
    const item = items[i];
    if (isHit(player, item)) {
      if (item.type === "param") {
        playSound(900);
        switch (item.op) {
          case "+": hp += item.value; break;
          case "-": hp -= item.value; break;
          case "×": hp *= item.value; break;
          case "÷": hp = Math.floor(hp / item.value); break;
        }
        if (hp > HP_MAX) hp = HP_MAX;
        if (hp <= 0) {
          endGame(elapsedSec);
          return;
        }
        player.scale = 1.3;
      } else {
        playSound(250);
        hp -= item.value;
        if (hp <= 0) {
          endGame(elapsedSec);
          return;
        }
      }
      items.splice(i, 1);
    }
  }

  player.scale += (1 - player.scale) * 0.12;

  for (let i = items.length - 1; i >= 0; i--) {
    if (items[i].y > canvas.height) items.splice(i, 1);
  }
}

function endGame(time) {
  gameOver = true;
  alert(`ゲームオーバー\n生存時間：${time}秒`);
}

// ===== 描画 =====
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // レーン
  ctx.strokeStyle = "#444";
  lanes.forEach(x => {
    ctx.beginPath();
    ctx.moveTo(x + 20, 0);
    ctx.lineTo(x + 20, canvas.height);
    ctx.stroke();
  });

  // プレイヤー
  ctx.save();
  ctx.translate(player.x + 20, player.y + 20);
  ctx.scale(player.scale, player.scale);
  ctx.fillStyle = "cyan";
  ctx.fillRect(-20, -20, 40, 40);
  ctx.restore();

  // UI
  ctx.fillStyle = "white";
  ctx.font = "18px sans-serif";
  ctx.fillText("HP: " + hp + " / 100", 10, 30);
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  ctx.fillText("時間: " + elapsedSec + "秒", 260, 30);

  // アイテム
  items.forEach(item => {
    if (item.type === "param") {
      ctx.fillStyle = "#eee"; // 全パラメータ同色
      ctx.fillRect(item.x, item.y, 40, 30);
      ctx.fillStyle = "black";
      ctx.fillText(item.op + item.value, item.x + 5, item.y + 22);
    } else {
      ctx.fillStyle = "red";
      ctx.fillRect(item.x, item.y, 40, 30);
      ctx.fillStyle = "white";
      ctx.fillText(item.value, item.x + 8, item.y + 22);
    }
  });
}

// ===== ループ =====
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
